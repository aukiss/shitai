
<!doctype html><html lang="zh-CN"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
<title>è¯‘æ—å…­å¹´çº§ï½œè¯­æ³•ä¸æ—¶æ€ Â· AIå­¦ç»ƒç³»ç»Ÿ</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{ --brand:#1e90ff; --ink:#222; --muted:#666; --bg:#f7fbff; --card:#fff; --chip:#eef6ff; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans SC","PingFang SC","Microsoft YaHei",sans-serif;}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;padding:10px 12px;display:flex;gap:10px;align-items:center;z-index:10}
  main{max-width:1200px;margin:16px auto;padding:0 12px 80px}
  .tabs{display:flex;gap:8px;margin:8px 0;overflow:auto;-webkit-overflow-scrolling:touch}
  .tab{padding:10px 14px;border-radius:999px;background:#eef3ff;cursor:pointer;flex:0 0 auto}
  .tab.active{background:var(--brand);color:#fff}
  .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:14px}
  .card{background:var(--card);border:1px solid #e9eef5;border-radius:14px;box-shadow:0 2px 10px rgba(30,144,255,.06);padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{font-size:16px}
  input[type=text],input[type=password],select{padding:12px;border:1px solid #dbe6f5;border-radius:12px;outline:none;min-width:120px}
  button{padding:12px 16px;border:0;border-radius:12px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
  button.ghost{background:#eef3ff;color:#124}
  .quiz-item{border:1px dashed #d6e6ff;border-radius:12px;padding:12px;margin:12px 0}
  .explain{background:#fffbe6;border:1px solid #ffe58f;padding:10px;border-radius:10px;margin-top:8px}
  .chip{display:inline-block;padding:4px 8px;background:var(--chip);border-radius:999px;font-size:12px;margin-right:6px}
  .meter{height:12px;background:#eef3ff;border-radius:999px;overflow:hidden;margin-top:6px}
  .meter>span{display:block;height:100%;background:linear-gradient(90deg,#7bd389,var(--brand));width:0%}
  .hint-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .hint-btn{background:#ffe9d6;color:#8a3f00}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .box{background:#fff;max-width:720px;width:100%;border-radius:14px;padding:16px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} main{padding-bottom:120px} header{position:sticky} }
  @media (pointer:coarse){ button,input,select{min-height:44px} label{min-height:44px;display:flex;align-items:center} }
  @media print{header,.no-print,.tabs,.modal{display:none !important} body{background:#fff} .print-page{page-break-after:always}}
</style>
</head><body>
<header class="no-print">
  <b>ğŸ“˜ è¯‘æ—å…­å¹´çº§ï½œè¯­æ³•ä¸æ—¶æ€</b>
  <span style="margin-left:auto;color:#045" id="who">æœªç™»å½•</span>
</header>
<main>
  <div class="tabs no-print">
    <div class="tab active" data-tab="practice">ç»ƒä¹ </div>
    <div class="tab" data-tab="class">ç­çº§é¢æ¿</div>
    <div class="tab" data-tab="settings">ä¸ªäººè®¾ç½®</div>
  </div>

  <section id="pane-practice">
    <div class="grid">
      <section class="card">
        <h3>ğŸ” ç™»å½•</h3>
        <div class="row">
          <input id="phone" placeholder="æ‰‹æœºå·ï¼ˆä»…æ•°å­—ï¼‰" inputmode="numeric" />
          <input id="pw" type="password" placeholder="å¯†ç ï¼ˆâ‰¥6ä½ï¼‰" />
          <input id="nick" placeholder="æ˜µç§°ï¼ˆå¯é€‰ï¼‰" />
          <input id="classId" placeholder="ç­çº§IDï¼ˆå¦‚ ClassAï¼‰" />
          <button id="btnLogin" type="button">ç™»å½•</button>
          <button id="btnReg" type="button" class="ghost">æ³¨å†Œ</button>
        </div>
        <div id="authMsg" style="color:#666;margin-top:6px"></div>
        <hr/>
        <h3>ğŸ¯ ç»ƒä¹ </h3>
        <div class="row">
          <select id="unit">
            <option value="">ï¼ˆç³»ç»Ÿæ¨èï¼‰</option>
            <option>U1-è¿‡å»è¿›è¡Œæ—¶</option>
            <option>U2-ä¸€èˆ¬è¿‡å»æ—¶ vs ç°åœ¨å®Œæˆæ—¶</option>
            <option>U3-ä¸»è°“ä¸€è‡´ï¼ˆåŸºç¡€ï¼‰</option>
            <option>U4-è¢«åŠ¨è¯­æ€å…¥é—¨</option>
            <option>U5-çŠ¶è¯­ä»å¥ï¼ˆæ—¶é—´/åŸå› ï¼‰</option>
            <option>ç»¼åˆ-æ˜“é”™ç‚¹æ··åˆ</option>
          </select>
          <select id="count"><option>5</option><option selected>10</option><option>15</option></select>
          <button id="btnStart" type="button">å¼€å§‹å‡ºé¢˜</button>
          <button id="btnA4" type="button" class="ghost">ä¸‹è½½A4</button>
          <button id="btnSprint" type="button" class="ghost">è€ƒè¯•å‘¨å†²åˆºåŒ…</button>
        </div>
        <div id="quiz"></div>
        <div class="row">
          <button id="btnSubmit" type="button" class="ghost">æäº¤åˆ¤åˆ†</button>
          <button id="btnReview" type="button">ä»Šæ—¥å¤ä¹ </button>
        </div>
        <div id="result" style="margin-top:6px;color:#444"></div>
      </section>

      <section class="card">
        <h3>ğŸ§­ è¿›åº¦</h3>
        <div class="meter"><span id="meter"></span></div>
        <div style="font-size:14px;color:#666">æŒæ¡åº¦ <b id="pct">0%</b> Â· è¿ç»­æ‰“å¡ <b id="streak">0</b> å¤©</div>
        <details style="margin-top:8px" open>
          <summary>ğŸ“‚ å¯¼å…¥çœŸé¢˜ï¼ˆCSV/JSONï¼‰</summary>
          <input id="fileBank" type="file" accept=".csv,.json,.jsonl" />
          <div id="bankMsg" style="font-size:12px;color:#666"></div>
        </details>
        <details>
          <summary>ğŸ–¼ï¸ è¯•å·å›¾ç‰‡åˆ†æ</summary>
          <input id="filePaper" type="file" accept="image/*" />
          <div class="row"><button id="btnAnalyze" type="button" class="ghost">åˆ†æ</button></div>
          <div id="paperOut" style="font-size:14px;color:#444"></div>
        </details>
      </section>
    </div>
    <section id="printArea" class="card" style="margin-top:12px">
      <h3>ğŸ“„ A4 æ‰“å°ç»ƒä¹ </h3>
      <div id="worksheet"></div>
    </section>
  </section>

  <section id="pane-class" style="display:none">
    <section class="card">
      <h3>ğŸ« ç­çº§é¢æ¿</h3>
      <div class="row">
        <button id="btnRefreshClass" type="button" class="ghost">åˆ·æ–°æ•°æ®</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
        <div class="card">
          <h4>æ­£ç¡®ç‡æ’è¡Œæ¦œï¼ˆTop 10ï¼‰</h4>
          <ol id="rankList"></ol>
        </div>
        <div class="card">
          <h4>ç­çº§æ¦‚è§ˆ</h4>
          <div id="overviewBox" style="color:#444"></div>
          <canvas id="chartRate" height="200"></canvas>
        </div>
      </div>
    </section>
  </section>

  <section id="pane-settings" style="display:none">
    <section class="card">
      <h3>ğŸ‘¤ ä¸ªäººè®¾ç½®</h3>
      <div class="row">
        <input id="profileNick" placeholder="æ˜µç§°" />
        <input id="profileClass" placeholder="ç­çº§IDï¼ˆå¦‚ ClassAï¼‰" />
        <button id="btnSaveProfile" type="button">ä¿å­˜</button>
      </div>
      <div id="profileMsg" style="font-size:12px;color:#666;margin-top:6px"></div>
    </section>
  </section>
</main>

<!-- å†²åˆºåŒ…å¼¹çª— -->
<div id="dlgSprint" class="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">ğŸ—“ï¸ è€ƒè¯•å‘¨å†²åˆºè®¡åˆ’ï¼ˆ7å¤©ï¼‰</h3>
      <button onclick="closeSprint()" class="ghost">å…³é—­</button>
    </div>
    <div id="sprintPlan" style="margin-top:8px"></div>
    <div class="row" style="margin-top:8px">
      <button onclick="downloadSprintPDF()">ä¸‹è½½ä¸ºPDF</button>
    </div>
  </div>
</div>

<script>
const API = {
  async req(path, method='GET', body=null){
    const headers = {'Content-Type':'application/json'};
    const t = localStorage.getItem('token'); if(t) headers['Authorization'] = 'Bearer '+t;
    const res = await fetch('/api/'+path, {method, headers, body: body? JSON.stringify(body): null});
    const txt = await res.text();
    try{ return JSON.parse(txt);}catch{ return {ok:false, error:txt}; }
  },
  login: (p)=>API.req('auth-login','POST',p),
  register: (p)=>API.req('auth-register','POST',p),
  saveProgress: (p)=>API.req('progress','POST',p),
  getProgress: ()=>API.req('progress','GET'),
  getBank: ()=>API.req('bank','GET'),
  setBank: (items)=>API.req('bank','POST',{items}),
  chat: (payload)=>API.req('ai-proxy','POST',payload),
  getProfile: ()=>API.req('profile','GET'),
  setProfile: (p)=>API.req('profile','POST',p),
  classStats: ()=>API.req('class-stats','GET'),
};

document.querySelectorAll('.tab').forEach(function(t){
  t.onclick = function(){
    document.querySelectorAll('.tab').forEach(function(x){ x.classList.remove('active'); });
    t.classList.add('active');
    var target = t.getAttribute('data-tab');
    document.querySelectorAll('section[id^=pane-]').forEach(function(p){
      p.style.display = (p.id === 'pane-'+target) ? '' : 'none';
    });
  };
});

var current = []; var answers={}; var bank=[]; var stats={done:0,correct:0,streak:0,lastDay:''}; var mistakes=[]; var chart=null;

function toast(t){ var d=document.createElement('div'); d.textContent=t; Object.assign(d.style,{position:'fixed',left:'50%',top:'20px',transform:'translateX(-50%)',background:'#222',color:'#fff',padding:'10px 14px',borderRadius:'999px',zIndex:9999}); document.body.appendChild(d); setTimeout(function(){d.remove();},1600); }
function esc(s){return (s||'').replace(/[&<>"']/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m];});}
function shuffle(a){for(var i=a.length-1;i>0;i--){var j=(Math.random()*(i+1))|0; var tmp=a[i]; a[i]=a[j]; a[j]=tmp; }}

function ensureLoginUI(){
  var who = document.querySelector('#who');
  var t = localStorage.getItem('token'), phone = localStorage.getItem('phone');
  who.textContent = t? ('å·²ç™»å½•ï¼š'+(phone||'')) : 'æœªç™»å½•';
}
async function afterLogin(){
  ensureLoginUI();
  await loadProgress();
  await loadProfile();
  document.querySelector('#authMsg').textContent = 'å·²ç™»å½•';
}
document.querySelector('#btnReg').onclick = async function(){
  var phone = document.querySelector('#phone').value.trim();
  var password = document.querySelector('#pw').value;
  var nickname = document.querySelector('#nick').value.trim();
  var class_id = document.querySelector('#classId').value.trim();
  var r = await API.register({phone:phone,password:password,nickname:nickname,class_id:class_id});
  document.querySelector('#authMsg').textContent = r.ok? 'æ³¨å†ŒæˆåŠŸï¼Œå·²ç™»å½•' : 'å¤±è´¥ï¼š'+(r.error||''); 
  if(r.ok){ localStorage.setItem('token', r.data.token); localStorage.setItem('phone', r.data.user.phone); afterLogin(); }
};
document.querySelector('#btnLogin').onclick = async function(){
  var phone = document.querySelector('#phone').value.trim();
  var password = document.querySelector('#pw').value;
  var r = await API.login({phone:phone,password:password});
  document.querySelector('#authMsg').textContent = r.ok? 'ç™»å½•æˆåŠŸ' : 'å¤±è´¥ï¼š'+(r.error||''); 
  if(r.ok){ localStorage.setItem('token', r.data.token); localStorage.setItem('phone', r.data.user.phone); afterLogin(); }
};

document.querySelector('#fileBank').onchange = async function(e){
  var f = e.target.files && e.target.files[0]; if(!f) return;
  var box = document.querySelector('#bankMsg'); box.textContent='å¯¼å…¥ä¸­â€¦';
  try{
    var txt = await f.text(); var arr=[];
    if(f.name.endsWith('.csv')){ var parsed = Papa.parse(txt,{header:true,skipEmptyLines:true}); arr = parsed.data; }
    else if(f.name.endsWith('.jsonl')){ arr = txt.trim().split(/\\n+/).map(function(s){return JSON.parse(s);}); }
    else { arr = JSON.parse(txt); }
    arr = (Array.isArray(arr)?arr:[arr]).map(function(r){ return {unit:r.unit||'ç»¼åˆ', grammar:r.grammar||'ç»¼åˆ', type:r.type||'å•é€‰', stem:String(r.stem||'').trim(), A:r.A||'', B:r.B||'', C:r.C||'', D:r.D||'', answer:(r.answer||'').toString().trim().toUpperCase(), explanation:r.explanation||'', source:r.source||'', difficulty:r.difficulty||2}; });
    var resp = await API.setBank(arr);
    box.textContent = resp.ok? ('å·²ä¸Šä¼ ï¼š'+arr.length+'é¢˜') : ('å¤±è´¥ï¼š'+resp.error);
  }catch(err){ box.textContent='å¤±è´¥ï¼š'+(err.message||err); }
};

async function startQuiz(){
  var sel = document.querySelector('#unit').value;
  var count = parseInt(document.querySelector('#count').value,10);
  if(bank.length===0){
    var r = await API.getBank(); if(r.ok) bank = r.data.items || [];
  }
  var chosen = bank.filter(function(q){ return !sel || (q.unit||'').indexOf(sel) > -1; });
  shuffle(chosen);
  chosen = chosen.slice(0, count);
  if(chosen.length < count){
    var need = count - chosen.length;
    var gen = await aiMake(need, sel || 'å…­å¹´çº§è¯‘æ—ç»¼åˆ');
    chosen = chosen.concat(gen);
  }
  current = chosen.map(function(q,i){ q.idx=i; return q; });
  answers={};
  renderQuiz();
}
document.querySelector('#btnStart').onclick = startQuiz;

function renderQuiz(){
  var area = document.querySelector('#quiz'); area.innerHTML='';
  current.forEach(function(q,i){
    var div = document.createElement('div'); div.className='quiz-item';
    var opts = ['A','B','C','D'].filter(function(k){return q[k];});
    var html = '<div><span class="chip">'+esc(q.unit)+'</span><span class="chip">'+esc(q.grammar)+'</span><span class="chip">'+esc(q.type)+'</span></div>';
    html += '<div style="margin-top:6px;font-weight:700;font-size:18px">'+(i+1)+'. '+esc(q.stem)+'</div>';
    if(opts.length){
      opts.forEach(function(k){
        html += '<label style="display:block;margin:6px 0"><input type="radio" name="q_'+i+'" value="'+k+'"/> '+k+'. '+esc(q[k])+'</label>';
      });
    }else{
      html += '<input data-q="'+i+'" placeholder="å¡«ç©ºâ€¦" style="width:100%"/>';
    }
    html += '<div class="hint-row"><button class="hint-btn" data-hint="1" data-i="'+i+'">æç¤º1</button><button class="hint-btn" data-hint="2" data-i="'+i+'">æç¤º2</button><button class="hint-btn" data-hint="3" data-i="'+i+'">æç¤º3</button></div>';
    html += '<div class="explain" style="display:none"></div>';
    div.innerHTML = html;
    area.appendChild(div);
  });
  area.querySelectorAll('.hint-btn').forEach(function(btn){
    btn.onclick = async function(){
      var level = parseInt(btn.getAttribute('data-hint'),10);
      var idx = parseInt(btn.getAttribute('data-i'),10);
      var q = current[idx];
      var hint = await aiHint(q, level);
      var ex = btn.parentElement.nextElementSibling;
      ex.style.display='block';
      ex.innerHTML = '<b>æç¤º'+level+'ï¼š</b>'+hint;
    };
  });
  document.querySelector('#result').textContent='';
}

async function submit(){
  document.querySelectorAll('input[type="radio"]:checked, input[data-q]').forEach(function(el){
    var idx = el.name? parseInt(el.name.split('_')[1],10): parseInt(el.getAttribute('data-q'),10);
    answers[idx] = (el.value||'').trim();
  });
  var correct=0;
  var nodes = Array.prototype.slice.call(document.querySelectorAll('.quiz-item'));
  for(var i=0;i<current.length;i++){
    var q = current[i];
    var node = nodes[i];
    var user = (answers[i]||'').toUpperCase();
    var right = (user === (q.answer||'').toUpperCase());
    if(right) correct++;
    var pack = await aiExplainRich(q, user, right);
    var expBox = node.querySelector('.explain'); 
    expBox.style.display='block'; 
    var html = '';
    html += 'ä½ çš„ç­”æ¡ˆï¼š<b style="color:'+(right?'#0a8c5f':'#c0392b')+'">'+esc(user||'ï¼ˆæœªä½œç­”ï¼‰')+'</b><br/>æ­£ç¡®ç­”æ¡ˆï¼š<b>'+esc(q.answer||'')+'</b>';
    html += '<div style="margin-top:6px">'+ (pack.reason || '') +'</div>';
    if(pack.rule){ html += '<details><summary>æœ¬é¢˜è§„åˆ™/é”™å› æ ‡ç­¾</summary><div>'+pack.rule+'</div></details>'; }
    if(pack.example){ html += '<details><summary>ç›¸ä¼¼ä¾‹å­</summary><div>'+pack.example+'</div></details>'; }
    if(pack.distractors){
      html += '<details><summary>å¹²æ‰°é¡¹ä¸ºä»€ä¹ˆé”™ï¼Ÿ</summary><ul>';
      ['A','B','C','D'].forEach(function(k){ if(pack.distractors[k]) html += '<li><b>'+k+'</b>ï¼š'+pack.distractors[k]+'</li>'; });
      html += '</ul></details>';
    }
    expBox.innerHTML = html;
    if(!right) pushMistake(q, user);
  }
  var today = new Date().toISOString().slice(0,10);
  if(stats.lastDay !== today){ stats.streak += 1; stats.lastDay = today; }
  stats.done += current.length; stats.correct += correct;
  await API.saveProgress({stats:stats, mistakes:mistakes, records:[]});
  renderStats();
  var rate = Math.round(correct/current.length*100);
  document.querySelector('#result').innerHTML = 'å…± <b>'+current.length+'</b> é¢˜ï¼Œæ­£ç¡® <b style="color:#0a8c5f">'+correct+'</b>ï¼ˆ'+rate+'%ï¼‰';
}
document.querySelector('#btnSubmit').onclick = submit;

function pushMistake(q, user){
  var key = btoa(unescape(encodeURIComponent(q.stem+'||'+(q.answer||'')))).slice(0,24);
  var EB = [5,30,720,1440,2880,5760,10080,21600]; // åˆ†é’Ÿ
  var now = Date.now();
  var found = mistakes.find(function(x){return x.key===key;});
  if(found){ found.step = Math.max(0, found.step-1); found.user=user; found.nextReview = now + EB[found.step]*60000; }
  else mistakes.push({key:key, unit:q.unit, grammar:q.grammar, stem:q.stem, A:q.A,B:q.B,C:q.C,D:q.D, answer:q.answer, explanation:q.explanation, user:user, step:0, nextReview: now + EB[0]*60000});
}

async function startReview(){
  var now = Date.now();
  var due = mistakes.filter(function(m){return m.nextReview<=now;}).slice(0,10);
  if(due.length===0){ toast('ä»Šå¤©æ²¡æœ‰åˆ°æœŸå¤ä¹ é¢˜'); return; }
  current = due.map(function(m,i){ return {unit:m.unit, grammar:m.grammar, type:'é”™é¢˜å¤ä¹ ', stem:m.stem, A:m.A,B:m.B,C:m.C,D:m.D, answer:m.answer, explanation:m.explanation, idx:i}; });
  answers={}; renderQuiz(); toast('å·²åŠ è½½åˆ°æœŸå¤ä¹ é¢˜');
}
document.querySelector('#btnReview').onclick = startReview;

function renderStats(){
  var total = Math.max(1, stats.done);
  var pctVal = Math.min(100, Math.round(stats.correct/total*100));
  document.querySelector('#meter').style.width = pctVal+'%';
  document.querySelector('#pct').textContent = pctVal+'%';
  document.querySelector('#streak').textContent = stats.streak;
}

async function loadProgress(){
  var r = await API.getProgress();
  if(r.ok){ var d=r.data; stats=d.stats||stats; mistakes=d.mistakes||[]; renderStats(); }
}
async function loadProfile(){
  var r = await API.getProfile();
  if(r.ok){
    document.querySelector('#profileNick').value = r.data.nickname || '';
    document.querySelector('#profileClass').value = r.data.class_id || '';
  }
}
document.querySelector('#btnSaveProfile').onclick = async function(){
  var nickname = document.querySelector('#profileNick').value.trim();
  var class_id = document.querySelector('#profileClass').value.trim();
  var r = await API.setProfile({nickname:nickname, class_id:class_id});
  document.querySelector('#profileMsg').textContent = r.ok? 'å·²ä¿å­˜' : 'å¤±è´¥ï¼š'+(r.error||'');
};

async function aiMake(n, topic){
  var sys = 'ä½ æ˜¯å°å­¦è‹±è¯­æ•™ç»ƒï¼Œæ•™æä½“ç³»ä¸ºâ€œè¯‘æ—ç‰ˆ å…­å¹´çº§â€ã€‚å‡ºé¢˜è¦æ±‚ï¼š\\n- é¢˜å‹ï¼šå•é€‰æˆ–å¡«ç©ºï¼Œèšç„¦â€œ'+topic+'â€\\n- è¾“å‡º JSON æ•°ç»„ questions[]ï¼Œæ¯é¢˜å« unit,grammar,type,stem,A,B,C,D,answer,explanationã€‚\\n- éš¾åº¦é€‚ä¸­ï¼Œé¿å…åˆé’»ã€‚';
  var usr = 'è¯·ç”Ÿæˆ '+n+' é¢˜ã€‚';
  var res = await API.chat({messages:[{role:'system',content:sys},{role:'user',content:usr}], response_format:{type:'json_object'}});
  var content = (res.choices && res.choices[0] && res.choices[0].message && res.choices[0].message.content) || '{}';
  var list=[]; try{ var obj = JSON.parse(content); list = obj.questions||[]; }catch(e){}
  list = (Array.isArray(list)?list:[]).map(function(r){ return {unit:r.unit||'ç»¼åˆ', grammar:r.grammar||'ç»¼åˆ', type:r.type||'å•é€‰', stem:String(r.stem||'').trim(), A:r.A||'', B:r.B||'', C:r.C||'', D:r.D||'', answer:(r.answer||'').toString().trim().toUpperCase(), explanation:r.explanation||'', source:r.source||'', difficulty:r.difficulty||2}; }).filter(function(q){return q.stem && q.answer;});
  return list;
}
async function aiHint(q, level){
  var p = 'è¯·é’ˆå¯¹è¿™é“å…­å¹´çº§é¢˜ç›®æä¾›â€œç¬¬'+level+'çº§æç¤ºâ€ï¼šç¬¬1çº§åªæç¤ºè¯­æ³•ç‚¹ï¼›ç¬¬2çº§ç»™å…³é”®è¯æˆ–æ—¶é—´ä¿¡å·è¯ï¼›ç¬¬3çº§ç»™åŠæˆå¥æ¡†æ¶ä½†ä¸ç›´æ¥ç»™ç­”æ¡ˆã€‚é¢˜ç›®ï¼š'+ JSON.stringify({stem:q.stem, options:{A:q.A,B:q.B,C:q.C,D:q.D}, grammar:q.grammar});
  var r = await API.chat({messages:[{role:'system',content:'ä½ æ˜¯ç®€æ´çš„è‹±è¯­è€å¸ˆã€‚'},{role:'user',content:p}]});
  return (r.choices && r.choices[0] && r.choices[0].message && r.choices[0].message.content) || 'ï¼ˆæç¤ºç”Ÿæˆå¤±è´¥ï¼‰';
}
async function aiExplainRich(q, user, isRight){
  var p = 'è¯·ä»¥JSONè¾“å‡ºå¯¹å°å­¦ç”Ÿå‹å¥½çš„è®²è§£ï¼š{reason, rule, example, distractors{A,B,C,D}}ã€‚è¦æ±‚ï¼š1) å¼€å¤´å…ˆè¯´æ˜ä½œç­”æ˜¯å¦æ­£ç¡®å¹¶ç®€è¦åŸå› ï¼ˆreasonï¼‰ï¼›2) ç”¨å­©å­èƒ½æ‡‚çš„è¯è®²æ¸…è§„åˆ™ï¼ˆruleï¼‰ï¼›3) ç»™ä¸€ä¸ªç›¸ä¼¼ä¾‹å­ï¼ˆexampleï¼‰ï¼›4) å¯¹æ¯ä¸ªå¹²æ‰°é¡¹å†™ä¸€å¥â€œä¸ºä»€ä¹ˆçœ‹èµ·æ¥å¯¹ä½†é”™åœ¨â€¦â€¦â€ï¼ˆdistractorsï¼‰ã€‚é¢˜ç›®ï¼š'+ JSON.stringify({stem:q.stem, options:{A:q.A,B:q.B,C:q.C,D:q.D}, user:user, answer:q.answer, grammar:q.grammar});
  var r = await API.chat({messages:[{role:'system',content:'ä½ æ˜¯è€å¿ƒçš„è‹±è¯­è€å¸ˆï¼Œè¾“å‡ºå¿…é¡»æ˜¯JSONã€‚'},{role:'user',content:p}], response_format:{type:'json_object'}});
  var content = (r.choices && r.choices[0] && r.choices[0].message && r.choices[0].message.content) || '{}';
  try{ return JSON.parse(content); }catch(e){ return {reason:'ï¼ˆè®²è§£ç”Ÿæˆå¤±è´¥ï¼‰'}; }
}

document.querySelector('#btnA4').onclick = async function(){
  if(current.length===0){ toast('è¯·å…ˆå‡ºé¢˜'); return; }
  buildWorksheet();
  await html2pdf().set({ margin:10, filename:'A4_ç»ƒä¹ _'+Date.now()+'.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} }).from(document.querySelector('#worksheet')).save();
};
function buildWorksheet(){
  var ws = document.querySelector('#worksheet'); ws.innerHTML='';
  var n=10; for(var i=0;i<current.length;i+=n){
    var page = current.slice(i,i+n);
    var div=document.createElement('div'); div.className='print-page';
    var html = '<h3 style="text-align:center;margin:6px 0 12px">è¯‘æ—å…­å¹´çº§Â·è¯­æ³•ä¸æ—¶æ€ A4ï¼ˆç¬¬ '+(i/n+1)+' é¡µï¼‰</h3><ol>';
    page.forEach(function(q){
      html += '<li style="margin:8px 0">'+esc(q.stem)+ renderWorksheetOpts(q) +'</li>';
    });
    html += '</ol>';
    div.innerHTML = html;
    ws.appendChild(div);
  }
}
function renderWorksheetOpts(q){
  var opts=['A','B','C','D'].filter(function(k){return q[k];});
  if(opts.length===0) return '<div style="border-bottom:1px solid #ccc;width:60%;height:18px;margin-top:6px"></div>';
  var s = '<div>'; opts.forEach(function(k){ s += '<div>'+k+'. '+esc(q[k])+'</div>'; }); s += '</div>'; return s;
}

// å†²åˆºåŒ…
document.querySelector('#btnSprint').onclick = async function(){ await buildSprintPlan(); openSprint(); };
function openSprint(){ document.getElementById('dlgSprint').style.display='flex'; }
function closeSprint(){ document.getElementById('dlgSprint').style.display='none'; }
async function buildSprintPlan(){
  var weak = {}; (mistakes||[]).forEach(function(m){ weak[m.grammar] = (weak[m.grammar]||0)+1; });
  var top = Object.entries(weak).sort(function(a,b){return b[1]-a[1];}).slice(0,4).map(function(x){return x[0];});
  if(top.length===0){ top=['ä¸»è°“ä¸€è‡´','ä¸€èˆ¬è¿‡å»æ—¶','ç°åœ¨å®Œæˆæ—¶','è¢«åŠ¨è¯­æ€']; }
  var prompt = 'è¯·åŸºäºä»¥ä¸‹å­¦ç”Ÿçš„è–„å¼±ç‚¹ï¼Œç”Ÿæˆ7å¤©å†²åˆºè®¡åˆ’ï¼ˆè¡¨æ ¼+æ¯æ—¥ä»»åŠ¡æ¸…å•ï¼‰ï¼Œå¯¹è±¡æ˜¯å…­å¹´çº§ï¼Œè¯­æ³•ç‚¹æŒ‰ä»æ˜“åˆ°éš¾å¾ªåºå®‰æ’ï¼Œå«ï¼šå½“å¤©å¤ä¹ æ—§é”™é¢˜æ¡æ•°ã€ç»ƒä¹ æ–°é¢˜æ•°é‡ã€é‡ç‚¹è¯­æ³•å¾®è¯¾æ ‡é¢˜ã€å®¶é•¿æ£€æŸ¥è¦ç‚¹ã€‚è–„å¼±ç‚¹ï¼š'+top.join('ã€');
  var r = await API.chat({messages:[{role:'system',content:'ä½ æ˜¯å°å­¦è‹±è¯­æ•™ç»ƒï¼Œè¾“å‡ºä½¿ç”¨æœ‰åºåˆ—è¡¨å’Œå°æ ‡é¢˜ï¼Œé€‚åˆæ‰“å°ã€‚'},{role:'user',content:prompt}]});
  var text = (r.choices && r.choices[0] && r.choices[0].message && r.choices[0].message.content) || 'ï¼ˆç”Ÿæˆå¤±è´¥ï¼‰';
  document.getElementById('sprintPlan').innerHTML = '<div style="white-space:pre-wrap">'+text+'</div>';
}
async function downloadSprintPDF(){
  var el = document.querySelector('#sprintPlan');
  await html2pdf().set({ margin:10, filename:'è€ƒè¯•å‘¨å†²åˆº_'+Date.now()+'.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} }).from(el).save();
}

// ç­çº§é¢æ¿
document.querySelector('#btnRefreshClass').onclick = async function(){
  var r = await API.classStats();
  var list = (r.ok && r.data && r.data.members) ? r.data.members : [];
  var rank = list.slice(0,10).map(function(x){
    var rate = Math.round((x.stats.correct/Math.max(1,x.stats.done))*100);
    return '<li>'+ (x.nickname||x.phone) +' â€” æ­£ç¡®ç‡ '+rate+'% Â· è¿ç»­ '+(x.stats.streak||0)+' å¤©</li>';
  }).join('');
  document.querySelector('#rankList').innerHTML = rank || '<li>æš‚æ— æ•°æ®</li>';
  var overview = (r.ok && r.data && r.data.overview) ? r.data.overview : {avg_rate:0, avg_streak:0};
  document.querySelector('#overviewBox').innerHTML = 'ç­çº§å¹³å‡æ­£ç¡®ç‡ï¼š<b>'+overview.avg_rate+'%</b> Â· å¹³å‡è¿ç»­æ‰“å¡ï¼š<b>'+overview.avg_streak+'å¤©</b>';
  var labels = list.slice(0,10).map(function(x){return x.nickname||x.phone;});
  var data = list.slice(0,10).map(function(x){return Math.round((x.stats.correct/Math.max(1,x.stats.done))*100);});
  var ctx = document.getElementById('chartRate').getContext('2d');
  if(window.chartRate){ window.chartRate.destroy(); }
  window.chartRate = new Chart(ctx, { type:'bar', data:{labels:labels, datasets:[{label:'æ­£ç¡®ç‡(%)', data:data}]} , options:{responsive:true, scales:{y:{beginAtZero:true, max:100}}}});
};

ensureLoginUI(); loadProgress(); loadProfile();
</script>
</body></html>
